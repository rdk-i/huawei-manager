#!/bin/sh /etc/rc.common

START=99
STOP=10

USE_PROCD=1
PROG=/usr/bin/huawei-manager/ip_agent_daemon.py

start_service() {
    # Check if Python3 is available
    if ! command -v python3 >/dev/null 2>&1; then
        logger -t huawei-manager -p user.err "ERROR: python3 not found. Please install python3 package."
        return 1
    fi
    
    # Check if daemon script exists
    if [ ! -f "$PROG" ]; then
        logger -t huawei-manager -p user.err "ERROR: Daemon script not found at $PROG"
        return 1
    fi
    
    # Check if huawei-lte-api is installed
    if ! python3 -c "import huawei_lte_api" >/dev/null 2>&1; then
        logger -t huawei-manager -p user.warn "WARNING: huawei-lte-api not installed. Installing..."
        pip3 install huawei-lte-api >/dev/null 2>&1 || {
            logger -t huawei-manager -p user.err "ERROR: Failed to install huawei-lte-api"
            return 1
        }
    fi
    
    procd_open_instance
    procd_set_param command python3 "$PROG"
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param respawn
    procd_close_instance
    
    logger -t huawei-manager "Huawei Manager service started"
}

stop_service() {
    logger -t huawei-manager "Huawei Manager service stopping"
}

service_triggers() {
    procd_add_reload_trigger "huawei-manager"
}
