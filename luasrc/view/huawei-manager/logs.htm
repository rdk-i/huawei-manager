<%# Huawei Manager - Logs View (Content Only) %>

<style type="text/css">
.hm-logs-container {
    background: linear-gradient(145deg, #1a1a1a, #222);
    border-radius: 12px;
    border: 1px solid #333;
    overflow: hidden;
}
.hm-logs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: #222;
    border-bottom: 1px solid #333;
    flex-wrap: wrap;
    gap: 10px;
}
.hm-logs-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 10px;
}
.hm-logs-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}
.hm-logs-controls select {
    background: #2a2a2a;
    color: #fff;
    border: 1px solid #444;
    border-radius: 6px;
    padding: 6px 12px;
}
.hm-logs-controls label {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #aaa;
    font-size: 0.9rem;
}
.hm-logs-controls input[type="checkbox"] {
    width: 16px;
    height: 16px;
}
.hm-logs-btn {
    background: #333;
    color: #fff;
    border: none;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
}
.hm-logs-btn:hover {
    background: #444;
}
.hm-logs-btn.danger {
    background: rgba(244, 67, 54, 0.2);
    color: #f44336;
}
.hm-logs-btn.danger:hover {
    background: rgba(244, 67, 54, 0.3);
}

.hm-logs-content {
    height: 500px;
    overflow-y: auto;
    padding: 15px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.85rem;
    line-height: 1.6;
}
.hm-log-line {
    padding: 2px 0;
    border-bottom: 1px solid #2a2a2a;
}
.hm-log-line:last-child {
    border-bottom: none;
}
.hm-log-line.debug { color: #888; }
.hm-log-line.info { color: #4CAF50; }
.hm-log-line.warning { color: #ff9800; }
.hm-log-line.error { color: #f44336; }

.hm-log-timestamp {
    color: #666;
    margin-right: 10px;
}
.hm-log-level {
    font-weight: 600;
    margin-right: 10px;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 0.75rem;
}
.hm-log-level.DEBUG { background: #333; color: #888; }
.hm-log-level.INFO { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
.hm-log-level.WARNING { background: transparent; color: #ff9800; }
.hm-log-level.ERROR { background: rgba(244, 67, 54, 0.2); color: #f44336; }

.hm-logs-empty {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}
.hm-logs-empty-icon {
    font-size: 3rem;
    margin-bottom: 15px;
}

/* Log Level Indicator */
.hm-log-stats {
    display: flex;
    gap: 15px;
    padding: 10px 20px;
    background: #1a1a1a;
    border-top: 1px solid #333;
}
.hm-log-stat {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: #888;
}
.hm-log-stat-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}
.hm-log-stat-dot.info { background: #4CAF50; }
.hm-log-stat-dot.warning { background: #ff9800; }
.hm-log-stat-dot.error { background: #f44336; }
</style>

<div class="cbi-section">
    <div class="hm-logs-container">
        <div class="hm-logs-header">
            <div class="hm-logs-title">
                üìù Service Logs
            </div>
            <div class="hm-logs-controls">
                <select id="log-filter" onchange="filterLogs()">
                    <option value="all">All Levels</option>
                    <option value="error">Errors Only</option>
                    <option value="warning">Warnings+</option>
                    <option value="info">Info+</option>
                    <option value="debug">Debug (All)</option>
                </select>
                <label>
                    <input type="checkbox" id="auto-refresh" checked onchange="toggleAutoRefresh()">
                    Auto-refresh
                </label>
                <button class="hm-logs-btn" onclick="refreshLogs()">üîÑ Refresh</button>
                <button class="hm-logs-btn danger" onclick="clearLogs()">üóëÔ∏è Clear</button>
            </div>
        </div>
        
        <div id="logs-content" class="hm-logs-content">
            <div class="hm-logs-empty">
                <div class="hm-logs-empty-icon">üìù</div>
                <div>Loading logs...</div>
            </div>
        </div>
        
        <div class="hm-log-stats">
            <div class="hm-log-stat">
                <span class="hm-log-stat-dot info"></span>
                <span id="stat-info">0</span> Info
            </div>
            <div class="hm-log-stat">
                <span class="hm-log-stat-dot warning"></span>
                <span id="stat-warning">0</span> Warnings
            </div>
            <div class="hm-log-stat">
                <span class="hm-log-stat-dot error"></span>
                <span id="stat-error">0</span> Errors
            </div>
            <div class="hm-log-stat" style="margin-left: auto;">
                Last updated: <span id="last-updated">-</span>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
//<![CDATA[
var allLogs = [];
var refreshInterval = null;
var apiBase = '<%=luci.dispatcher.build_url("admin", "modem", "huawei-manager", "api")%>';

function fetchJSON(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.setRequestHeader('Accept', 'application/json');
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                try { callback(null, JSON.parse(xhr.responseText)); }
                catch(e) { callback(e, null); }
            } else {
                callback(new Error('HTTP ' + xhr.status), null);
            }
        }
    };
    xhr.send();
}

function parseLogLine(line) {
    // Parse format: 2024-01-01 12:00:00,123 - LEVEL - message (with optional milliseconds)
    var match = line.match(/^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}[,\.\d]*)\s*-\s*(\w+)\s*-\s*(.*)$/);
    if (match) {
        return {
            timestamp: match[1],
            level: match[2].toUpperCase(),
            message: match[3]
        };
    }
    
    // Fallback for different format
    match = line.match(/^(\w+)\s*-\s*(.*)$/);
    if (match) {
        return {
            timestamp: '',
            level: match[1].toUpperCase(),
            message: match[2]
        };
    }
    
    return {
        timestamp: '',
        level: 'INFO',
        message: line
    };
}

function refreshLogs() {
    fetchJSON(apiBase + '/logs', function(err, data) {
        if (err || !data) {
            console.error('Failed to fetch logs:', err);
            return;
        }
        
        allLogs = data.logs || [];
        filterLogs();
        
        document.getElementById('last-updated').innerText = new Date().toLocaleTimeString();
    });
}

function filterLogs() {
    var filter = document.getElementById('log-filter').value;
    var container = document.getElementById('logs-content');
    
    if (allLogs.length === 0) {
        container.innerHTML = '<div class="hm-logs-empty">' +
            '<div class="hm-logs-empty-icon">üìù</div>' +
            '<div>No logs available</div>' +
            '</div>';
        return;
    }
    
    var stats = { info: 0, warning: 0, error: 0, debug: 0 };
    var html = '';
    
    allLogs.forEach(function(line) {
        if (!line.trim()) return;
        
        var parsed = parseLogLine(line);
        var level = parsed.level.toLowerCase();
        
        // Count stats (before filtering)
        if (level === 'info') stats.info++;
        else if (level === 'warning') stats.warning++;
        else if (level === 'error') stats.error++;
        else if (level === 'debug') stats.debug++;
        
        // Apply filter
        var show = false;
        switch(filter) {
            case 'error':
                show = (level === 'error');
                break;
            case 'warning':
                show = (level === 'error' || level === 'warning');
                break;
            case 'info':
                show = (level === 'error' || level === 'warning' || level === 'info');
                break;
            case 'debug':
            case 'all':
            default:
                show = true;
                break;
        }
        
        if (!show) return;
        
        html += '<div class="hm-log-line ' + level + '">';
        if (parsed.timestamp) {
            html += '<span class="hm-log-timestamp">' + parsed.timestamp + '</span>';
        }
        html += '<span class="hm-log-level ' + parsed.level + '">' + parsed.level + '</span>';
        html += '<span class="hm-log-message">' + escapeHtml(parsed.message) + '</span>';
        html += '</div>';
    });
    
    container.innerHTML = html || '<div class="hm-logs-empty"><div>No matching logs</div></div>';
    
    // Update stats
    document.getElementById('stat-info').innerText = stats.info;
    document.getElementById('stat-warning').innerText = stats.warning;
    document.getElementById('stat-error').innerText = stats.error;
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.innerText = text;
    return div.innerHTML;
}

function clearLogs() {
    if (!confirm('Are you sure you want to clear all logs?')) return;
    
    fetchJSON(apiBase + '/clear_logs', function(err, data) {
        if (data && data.success) {
            allLogs = [];
            filterLogs();
        } else {
            alert('Failed to clear logs');
        }
    });
}

function toggleAutoRefresh() {
    var enabled = document.getElementById('auto-refresh').checked;
    
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
    
    if (enabled) {
        refreshInterval = setInterval(refreshLogs, 5000);
    }
}

// Initialize
refreshLogs();
toggleAutoRefresh();
//]]>

// Cleanup on page unload to prevent memory leaks
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
});
</script>
